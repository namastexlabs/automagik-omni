name: Desktop Build

on:
  push:
    branches: [main, dev]
    tags:
      - 'v*'
  pull_request:
    branches: [main, dev]
  workflow_dispatch:  # Allow manual trigger

env:
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "20"
  UV_VERSION: "0.5.11"

jobs:
  build-backend:
    name: Build Backend (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: automagik-omni-backend-linux
            platform: linux
          - os: windows-latest
            artifact_name: automagik-omni-backend-windows.exe
            platform: windows
          - os: macos-latest
            artifact_name: automagik-omni-backend-macos
            platform: macos

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv (Unix)
        if: runner.os != 'Windows'
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install uv (Windows)
        if: runner.os == 'Windows'
        run: |
          irm https://astral.sh/uv/install.ps1 | iex
          echo "$env:USERPROFILE\.cargo\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-uv-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Install Python dependencies
        run: |
          uv sync --all-extras

      - name: Install PyInstaller
        run: |
          uv pip install pyinstaller

      - name: Build backend with PyInstaller (Unix)
        if: runner.os != 'Windows'
        run: |
          chmod +x scripts/build-backend.sh
          ./scripts/build-backend.sh

      - name: Build backend with PyInstaller (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          # Use bash script on Windows with Git Bash
          bash scripts/build-backend.sh

      - name: Verify backend binary (Unix)
        if: runner.os != 'Windows'
        run: |
          ls -lh dist-python/
          file dist-python/automagik-omni-backend || true
          chmod +x dist-python/automagik-omni-backend
          ./dist-python/automagik-omni-backend --version || echo "Version check failed (may be expected)"

      - name: Verify backend binary (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          ls -lh dist-python/
          file dist-python/automagik-omni-backend.exe || true

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-${{ matrix.platform }}
          path: |
            dist-python/automagik-omni-backend*
          retention-days: 7

  build-electron:
    name: Build Electron UI (${{ matrix.os }})
    needs: build-backend
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            build_script: npm run electron:build:linux
          - os: windows-latest
            platform: windows
            build_script: npm run electron:build:win
          - os: macos-latest
            platform: macos
            build_script: npm run electron:build:mac

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            ui/node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('ui/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-${{ matrix.platform }}
          path: dist-python/

      - name: Make backend executable (Unix)
        if: runner.os != 'Windows'
        run: |
          chmod +x dist-python/automagik-omni-backend*
          ls -lh dist-python/

      - name: Install UI dependencies
        working-directory: ui
        run: pnpm install

      - name: Build Electron app (Linux)
        if: runner.os == 'Linux'
        working-directory: ui
        run: |
          # Install required Linux dependencies
          sudo apt-get update
          sudo apt-get install -y rpm
          pnpm run electron:build:linux

      - name: Build Electron app (Windows)
        if: runner.os == 'Windows'
        working-directory: ui
        run: |
          pnpm run electron:build:win

      - name: Build Electron app (macOS)
        if: runner.os == 'macOS'
        working-directory: ui
        run: |
          pnpm run electron:build:mac

      - name: Upload installers (Linux)
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: installers-linux
          path: |
            ui/dist/*.AppImage
            ui/dist/*.deb
          retention-days: 30

      - name: Upload installers (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: installers-windows
          path: |
            ui/dist/*.exe
          retention-days: 30

      - name: Upload installers (macOS)
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: installers-macos
          path: |
            ui/dist/*.dmg
            ui/dist/*.zip
          retention-days: 30

  create-release:
    name: Create Release
    needs: build-electron
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Display structure of downloaded artifacts
        run: ls -R artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          files: |
            artifacts/installers-linux/*
            artifacts/installers-windows/*
            artifacts/installers-macos/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-summary:
    name: Build Summary
    needs: [build-backend, build-electron]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ—ï¸ Desktop Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Backend Builds" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.build-backend.result }}" == "success" ]; then
            echo "âœ… **Backend:** Built successfully for all platforms" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Backend:** Build failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Electron UI Builds" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.build-electron.result }}" == "success" ]; then
            echo "âœ… **Electron UI:** Built successfully for all platforms" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Electron UI:** Build failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§ Linux: AppImage, DEB (amd64, arm64)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸªŸ Windows: NSIS Installer (.exe)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ macOS: DMG, ZIP" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.build-backend.result }}" == "success" ] && [ "${{ needs.build-electron.result }}" == "success" ]; then
            echo "âœ… **All builds successful!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Some builds failed - check logs above**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
